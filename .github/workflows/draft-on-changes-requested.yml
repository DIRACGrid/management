name: Draft on Changes Requested

on:
  workflow_call:
    secrets:
      token:
        required: true

jobs:
  convert-to-draft:
    runs-on: ubuntu-latest
    steps:
      - name: Convert PR to draft
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            const run = context.payload.workflow_run;
            if (!run) {
              core.setFailed("This workflow must be called from a workflow_run trigger.");
              return;
            }

            const owner = run.head_repository.owner.login;
            const branch = run.head_branch;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              head: `${owner}:${branch}`,
            });

            if (prs.length === 0) {
              core.info("No open PR found for this branch.");
              return;
            }

            const pr = prs[0];
            if (pr.draft) {
              core.info(`PR #${pr.number} is already a draft, skipping.`);
              return;
            }

            await github.graphql(`
              mutation($id: ID!) {
                convertPullRequestToDraft(input: { pullRequestId: $id }) {
                  pullRequest { isDraft }
                }
              }
            `, { id: pr.node_id });

            core.info(`Converted PR #${pr.number} to draft.`);
