name: Draft on Changes Requested

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
    secrets:
      token:
        required: true

jobs:
  convert-to-draft:
    runs-on: ubuntu-latest
    steps:
      - name: Convert PR to draft
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            const prNumber = ${{ inputs.pr_number }};
            if (!Number.isInteger(prNumber) || prNumber <= 0) {
              core.setFailed(`Invalid PR number: ${prNumber}`);
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            if (pr.draft) {
              core.info(`PR #${prNumber} is already a draft, skipping.`);
              return;
            }

            await github.graphql(`
              mutation($id: ID!) {
                convertPullRequestToDraft(input: { pullRequestId: $id }) {
                  pullRequest { isDraft }
                }
              }
            `, { id: pr.node_id });

            core.info(`Converted PR #${prNumber} to draft.`);
